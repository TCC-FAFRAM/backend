generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id_usuario    Int      @id @default(autoincrement())
  nome          String
  sobre_nome    String
  email         String   @unique
  senha         String?
  cpf           String   @unique
  tipo          Role     @default(USER)
  data_cadastro DateTime @default(now())

  // Para usuarios do tipo USER, esses campos sao obrigatorios.
  // Para ADMIN e MASTER, poderao ser nulos.
  fk_id_funcao Int?
  Funcao       Funcao? @relation(fields: [fk_id_funcao], references: [id_funcao])

  fk_id_fazenda Int?
  Fazenda       Fazenda? @relation(fields: [fk_id_fazenda], references: [id_fazenda])

  // Campos de endereço (baseados na API de localidades do IBGE)
  distrito_id  Int?
  municipio_id Int?
  complemento  String?

  // Outras relacoes...
  Certificados               Certificado[]
  TentativasProva            TentativasProva[]
  CursosConcluidos           CursosConcluidos[]
  LiberacoesCursoFuncionario LiberacaoCurso[]   @relation(name: "FuncionarioLiberacao")
  LiberacoesCursoAdmin       LiberacaoCurso[]   @relation(name: "AdminLiberacao")
  AulasConcluidas            AulasConcluidas[]
}

model Fazenda {
  id_fazenda   Int       @id @default(autoincrement())
  nome         String
  proprietario String?
  descricao    String?
  distrito_id  Int?
  municipio_id Int?
  complemento  String?
  Usuarios     Usuario[]
}

model Funcao {
  id_funcao   Int           @id @default(autoincrement())
  nome        String
  FuncaoCurso FuncaoCurso[]
  Usuarios    Usuario[]
}

model Curso {
  id_curso        Int              @id @default(autoincrement())
  titulo          String
  descricao       String
  Modulos         Modulo[]
  Certificados    Certificado[]
  FuncaoCurso     FuncaoCurso[]
  LiberacoesCurso LiberacaoCurso[] @relation("CursoLiberacao")
}

model Modulo {
  id_modulo             Int               @id @default(autoincrement())
  titulo                String
  descricao             String
  ordem                 Int // Para controlar a sequência dos módulos
  concluido             Boolean           @default(false)
  aulas_concluidas      AulasConcluidas[]
  fk_id_curso           Int
  Curso                 Curso             @relation(fields: [fk_id_curso], references: [id_curso])
  Aulas                 Aula[]
  Prova                 Prova?
  ModuloAnterior        Modulo?           @relation("ModuloSequencia", fields: [fk_id_modulo_anterior], references: [id_modulo])
  ModulosPosteriores    Modulo[]          @relation("ModuloSequencia")
  fk_id_modulo_anterior Int?
}

model FuncaoCurso {
  fk_id_funcao Int
  fk_id_curso  Int
  Curso        Curso  @relation(fields: [fk_id_curso], references: [id_curso])
  Funcao       Funcao @relation(fields: [fk_id_funcao], references: [id_funcao])

  @@id([fk_id_funcao, fk_id_curso])
}

model Aula {
  id_aula          Int                @id @default(autoincrement())
  titulo           String
  url_video        String
  duracao          Int
  descricao        String
  fk_id_modulo     Int
  Modulo           Modulo             @relation(fields: [fk_id_modulo], references: [id_modulo])
  AulasConcluidas  AulasConcluidas[]
  CursosConcluidos CursosConcluidos[]
}

model CursosConcluidos {
  id_concluidos Int      @id @default(autoincrement())
  fk_id_usuario Int
  fk_id_aula    Int
  completado_em DateTime @default(now())
  Aula          Aula     @relation(fields: [fk_id_aula], references: [id_aula])
  Usuario       Usuario  @relation(fields: [fk_id_usuario], references: [id_usuario])
}

model Certificado {
  id_certificado  Int               @id @default(autoincrement())
  fk_id_usuario   Int
  fk_id_curso     Int
  data_emissao    DateTime          @default(now())
  url_certificado String
  status          StatusCertificado @default(INATIVO)
  Curso           Curso             @relation(fields: [fk_id_curso], references: [id_curso])
  Usuario         Usuario           @relation(fields: [fk_id_usuario], references: [id_usuario], onDelete: Cascade)
}

model Prova {
  id_prova        Int               @id @default(autoincrement())
  fk_id_modulo    Int               @unique
  nota_minima     Float
  total_perguntas Int
  Modulo          Modulo            @relation(fields: [fk_id_modulo], references: [id_modulo])
  TentativasProva TentativasProva[]
  Questoes        Questao[]
}

model Questao {
  id_questao       Int               @id @default(autoincrement())
  pergunta         String
  opcoes           String[] // Array de strings para as opções de resposta
  resposta_correta Int // Índice da opção correta
  peso             Int // 1 = fácil, 2 = médio, 3 = difícil
  fk_id_prova      Int
  Prova            Prova             @relation(fields: [fk_id_prova], references: [id_prova])
  RespostasAluno   RespostaQuestao[]
}

model RespostaQuestao {
  id_resposta     Int             @id @default(autoincrement())
  fk_id_questao   Int
  fk_id_tentativa Int
  resposta_aluno  Int // Índice da opção escolhida pelo aluno
  Questao         Questao         @relation(fields: [fk_id_questao], references: [id_questao])
  TentativaProva  TentativasProva @relation(fields: [fk_id_tentativa], references: [id_tentativa_prova])
}

model TentativasProva {
  id_tentativa_prova Int               @id @default(autoincrement())
  fk_id_funcionario  Int
  fk_id_prova        Int
  nota               Float
  data_tentativa     DateTime          @default(now())
  passou             Boolean
  Usuario            Usuario           @relation(fields: [fk_id_funcionario], references: [id_usuario])
  Prova              Prova             @relation(fields: [fk_id_prova], references: [id_prova])
  Respostas          RespostaQuestao[]
}

model LiberacaoCurso {
  id_liberacao_curso Int      @id @default(autoincrement())
  fk_id_funcionario  Int
  fk_id_curso        Int
  fk_id_admin        Int
  data_liberacao     DateTime @default(now())
  Admin              Usuario  @relation("AdminLiberacao", fields: [fk_id_admin], references: [id_usuario])
  Curso              Curso    @relation("CursoLiberacao", fields: [fk_id_curso], references: [id_curso])
  Funcionario        Usuario  @relation("FuncionarioLiberacao", fields: [fk_id_funcionario], references: [id_usuario])
}

model Log {
  id_log        Int      @id @default(autoincrement())
  tabela        String
  operacao      String
  id_registro   Int
  dados_antigos Json?
  dados_novos   Json?
  data_registro DateTime @default(now())
}

model AulasConcluidas {
  id_aula_concluida Int      @id @default(autoincrement())
  fk_id_usuario     Int
  fk_id_aula        Int
  completado_em     DateTime @default(now())
  Aula              Aula     @relation(fields: [fk_id_aula], references: [id_aula])
  Usuario           Usuario  @relation(fields: [fk_id_usuario], references: [id_usuario])
  Modulo            Modulo?  @relation(fields: [moduloId_modulo], references: [id_modulo])
  moduloId_modulo   Int?
}

enum Role {
  USER
  ADMIN
  MASTER
}

enum StatusCertificado {
  INATIVO
  SOLICITADO
  GERADO
  APROVADO
  RECEBIDO
}
